# =============================================================================
# PR Automation
# =============================================================================
# Auto-labels, assigns reviewers, and provides quality feedback on PRs.

name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  # ===========================================================================
  # Auto-Label PR
  # ===========================================================================
  auto-label:
    name: üè∑Ô∏è Auto-Label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Label size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: 10
          s_label: 'size/s'
          s_max_size: 100
          m_label: 'size/m'
          m_max_size: 500
          l_label: 'size/l'
          l_max_size: 1000
          xl_label: 'size/xl'
          fail_if_xl: false

  # ===========================================================================
  # Quality Feedback Comment
  # ===========================================================================
  quality-feedback:
    name: üí¨ Quality Feedback
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install SDK
        run: pip install -e ".[dev]"
      
      - name: Get changed files
        id: changed
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          cat changed_files.txt
      
      - name: Run guards on changed files
        id: guards
        run: |
          python -c "
          from sdk.guards import run_guards
          from pathlib import Path
          
          changed = Path('changed_files.txt').read_text().strip().split('\n')
          py_files = [f for f in changed if f.endswith('.py') and Path(f).exists()]
          
          total_errors = 0
          total_warnings = 0
          details = []
          
          for f in py_files:
              content = Path(f).read_text()
              result = run_guards(content, f)
              
              if result.violations:
                  errors = sum(1 for v in result.violations if v.severity.value == 'error')
                  warnings = sum(1 for v in result.violations if v.severity.value == 'warning')
                  total_errors += errors
                  total_warnings += warnings
                  
                  if errors > 0:
                      details.append(f'- **{f}**: {errors} errors, {warnings} warnings')
          
          # Generate markdown report
          report = []
          report.append('## üõ°Ô∏è Guard Analysis Results\n')
          
          if total_errors == 0 and total_warnings == 0:
              report.append('‚úÖ **All guards passed!** Great job!\n')
          else:
              if total_errors > 0:
                  report.append(f'‚ùå **{total_errors} error(s)** - Must fix before merge\n')
              if total_warnings > 0:
                  report.append(f'‚ö†Ô∏è **{total_warnings} warning(s)** - Consider fixing\n')
              
              if details:
                  report.append('\n### Files with issues:\n')
                  report.extend(details)
          
          report.append('\n---\n')
          report.append('*Run \`python -m sdk.guards.run <file>\` locally for details*')
          
          Path('guard-report.md').write_text('\n'.join(report))
          
          # Set output
          print(f'errors={total_errors}')
          print(f'warnings={total_warnings}')
          " >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('guard-report.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Guard Analysis Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
